name: Ultimate Minecraft Server (Google Drive)

on:
  workflow_dispatch: # Manual "Run" button

jobs:
  server:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Setup Environment
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Dependencies (Playit, Rclone, JQ)
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit jq zip unzip -y
          sudo -v ; curl https://rclone.org/install.sh | sudo bash

      # 2. Connect to Google Drive
      - name: Configure Google Drive
        env:
          GDRIVE_CONFIG: ${{ secrets.GDRIVE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$GDRIVE_CONFIG" > ~/.config/rclone/rclone.conf
          echo "‚úÖ Google Drive Configured!"

      # 3. Restore Backup (STRICT ORIGINAL LOGIC)
      - name: üì• Restore Backup
        run: |
          mkdir -p server/minecraft-worlds
          mkdir -p server/plugins
          
          echo "Checking Google Drive for previous backup..."
          rclone copy gdrive:MinecraftServer/backup.zip server/ || echo "No backup found. Starting Fresh!"
          
          if [ -f server/backup.zip ]; then
            echo "Backup found! Unzipping World & Plugins..."
            unzip -o server/backup.zip -d server/
            rm server/backup.zip
            touch server/BACKUP_WAS_RESTORED
          fi

      # 4. Setup Server Logic (Privacy, Seed & End Portal)
      - name: Configure Server & Folders
        env:
          SEED_SECRET: ${{ secrets.SEED }}
          END_PORTAL: ${{ secrets.END_PORTAL }}
        run: |
          echo "settings:" > server/bukkit.yml
          echo "  world-container: minecraft-worlds" >> server/bukkit.yml
          
          echo "commands:" > server/spigot.yml
          echo "  log: false" >> server/spigot.yml
          
          echo "server-port=25565" > server/server.properties
          echo "online-mode=false" >> server/server.properties
          echo "motd=SuperSMP Server" >> server/server.properties
          echo "eula=true" > server/eula.txt

          # --- END PORTAL TOGGLE ---
          if [ "$END_PORTAL" == "false" ]; then
            echo "allow-end=false" >> server/server.properties
            echo "  allow-end: false" >> server/bukkit.yml
          else
            echo "allow-end=true" >> server/server.properties
          fi
          
          # --- SEED LOGIC (STRICT ORIGINAL) ---
          if [ ! -f server/BACKUP_WAS_RESTORED ]; then
             if [ -n "$SEED_SECRET" ]; then
                echo "‚úÖ New World Detected! Applying Secret Seed..."
                echo "level-seed=$SEED_SECRET" >> server/server.properties
             fi
          fi

      # 5. Download Core & Plugins (Smart Version Check)
      - name: Download Paper (Smart Version Check) & Plugins
        run: |
          TARGET_VERSION="1.21.11"
          PROJECT_URL="https://api.papermc.io/v2/projects/paper"
          
          if curl -s $PROJECT_URL | jq -e ".versions | index(\"$TARGET_VERSION\")" > /dev/null; then
            VERSION="$TARGET_VERSION"
            echo "‚úÖ Targeting version $VERSION"
          else
            VERSION=$(curl -s $PROJECT_URL | jq -r '.versions[-1]')
            echo "‚ö†Ô∏è Version $TARGET_VERSION not found. Falling back to latest: $VERSION"
          fi
          
          BUILD=$(curl -s $PROJECT_URL/versions/$VERSION | jq '.builds[-1]')
          wget -O server/paper.jar "$PROJECT_URL/versions/$VERSION/builds/$BUILD/downloads/paper-$VERSION-$BUILD.jar"
          
          cp -r plugins/* server/plugins/

      # 6. Configure Plugins (DiscordSRV & Bedrock Nether)
      - name: üîß Configure Plugins
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        run: |
          if ls server/plugins/DiscordSRV*.jar 1> /dev/null 2>&1; then
            mkdir -p server/plugins/DiscordSRV
            echo "BotToken: \"$DISCORD_TOKEN\"" > server/plugins/DiscordSRV/config.yml
            echo "Channels: {\"global\": \"1454377524250284096\"}" >> server/plugins/DiscordSRV/config.yml
            echo "DiscordConsoleChannelId: \"1433750303089623120\"" >> server/plugins/DiscordSRV/config.yml
            echo "ConfigVersion: 1.26.0" >> server/plugins/DiscordSRV/config.yml
            echo "Experiment_JdbcAccountLinkBackend: true" >> server/plugins/DiscordSRV/config.yml
          fi

          if ls server/plugins/Geyser-Spigot*.jar 1> /dev/null 2>&1; then
            mkdir -p server/plugins/Geyser-Spigot
            echo "above-bedrock-nether-building: true" > server/plugins/Geyser-Spigot/config.yml
            echo "max-build-height: 256" >> server/plugins/Geyser-Spigot/config.yml
          fi

      # 7a. Start Silent Tunnel
      - name: üåê Start Silent Tunnel
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          playit --secret $PLAYIT_SECRET > playit_log.txt 2>&1 &
          sleep 15

      # 7b. Display Connection Info
      - name: ‚ú® Show Server IP
        run: |
          echo "------------------------------------------"
          echo "üöÄ YOUR MINECRAFT SERVER IS ONLINE!"
          echo "------------------------------------------"
          JAVA_IP=$(grep -oE '[a-zA-Z0-9.-]+\.joinmc\.link' playit_log.txt | head -n 1)
          echo "üñ•Ô∏è JAVA IP: ${JAVA_IP:-Check playit.gg dashboard}"
          BEDROCK_INFO=$(grep -oE '[a-zA-Z0-9.-]+\.ply\.gg:[0-9]+' playit_log.txt | head -n 1)
          echo "üì± BEDROCK: ${BEDROCK_INFO:-Check playit.gg dashboard}"
          echo "------------------------------------------"
          echo "üéÆ Logs below are only from Minecraft..."

      # 7c. Start Minecraft Server (FIXED: Force Kill Timeout)
      - name: üü¢ Start Server
        run: |
          cd server
          
          # 1. Start Server in Background
          java -Xms6G -Xmx6G -jar paper.jar nogui &
          SERVER_PID=$!
          
          # 2. Safety Timer Logic (Auto-Detects Manual Stop)
          START_TIME=$(date +%s)
          MAX_DURATION=19800 # 5.5 Hours
          
          echo "‚è≥ Server started. Monitoring for 5.5 hours or manual stop..."
          
          while kill -0 $SERVER_PID 2>/dev/null; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            # If timer runs out (5.5 hours)
            if [ $ELAPSED -ge $MAX_DURATION ]; then
              echo "‚è∞ Time limit reached (5.5h). Initiating shutdown..."
              
              # Try Graceful Stop
              echo "stop" > /proc/$SERVER_PID/fd/0
              
              # Give it 60 seconds to save and close
              count=0
              while kill -0 $SERVER_PID 2>/dev/null && [ $count -lt 6 ]; do
                sleep 10
                count=$((count+1))
                echo "Waiting for save... ($((count*10))s)"
              done
              
              # If still running after 60s, FORCE KILL
              if kill -0 $SERVER_PID 2>/dev/null; then
                 echo "‚ö†Ô∏è Server stuck! Force killing to ensure backup..."
                 kill -9 $SERVER_PID
              fi
              break
            fi
            sleep 10
          done
          
          # 3. Final Cleanup
          wait $SERVER_PID || true
          echo "‚úÖ Server process finished. Proceeding to backup..."

      # 8. Auto-Backup (STRICT ORIGINAL LOGIC)
      - name: üì§ Backup to Google Drive
        if: always()
        run: |
          cd server
          zip -r backup.zip minecraft-worlds plugins -x "*.jar"
          rclone copy backup.zip gdrive:MinecraftServer/
          echo "‚úÖ Backup Complete!"
