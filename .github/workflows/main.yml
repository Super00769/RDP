name: Ultimate Minecraft Server

on:
  workflow_dispatch: # Manual "Run" button

jobs:
  server:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Setup Environment
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Dependencies (Playit, Rclone, JQ)
        run: |
          # Install Playit
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit jq zip unzip
          
          # Install Rclone (for MEGA backup)
          sudo -v ; curl https://rclone.org/install.sh | sudo bash

      # 2. Connect to MEGA Cloud
      - name: Configure MEGA
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASS: ${{ secrets.MEGA_PASS }}
        run: |
          # Create a secure connection profile named 'mymega'
          rclone config create mymega mega user "$MEGA_EMAIL" pass "$MEGA_PASS"

      # 3. Restore World & Plugins (If backup exists)
      - name: ðŸ“¥ Restore Backup
        run: |
          mkdir -p server/minecraft-worlds
          mkdir -p server/plugins
          
          echo "Checking MEGA for previous backup..."
          
          # Try to download. If fail, just print message and continue.
          rclone copy mymega:minecraft-server/backup.zip server/ || echo "No backup found. Starting Fresh!"
          
          if [ -f server/backup.zip ]; then
            echo "Backup found! Unzipping World & Plugins..."
            unzip -o server/backup.zip -d server/
            rm server/backup.zip
          fi

      # 4. Setup Server Logic (Privacy & Seed)
      - name: Configure Server & Folders
        run: |
          # Force worlds into the 'minecraft-worlds' folder
          echo "settings:" > server/bukkit.yml
          echo "  world-container: minecraft-worlds" >> server/bukkit.yml
          
          # PRIVACY: Disable command logging (Hides /msg and /login from GitHub Logs)
          echo "commands:" > server/spigot.yml
          echo "  log: false" >> server/spigot.yml
          
          # Server Properties (Cracked + Optimized)
          echo "server-port=25565" > server/server.properties
          echo "online-mode=false" >> server/server.properties
          echo "motd=GitHub Actions Server" >> server/server.properties
          echo "eula=true" > server/eula.txt
          
          # SEED LOGIC: If seed.txt exists, add it to properties!
          if [ -f seed.txt ]; then
             SEED=$(cat seed.txt)
             echo "âœ… Custom Seed Found: $SEED"
             echo "level-seed=$SEED" >> server/server.properties
          else
             echo "âš ï¸ No seed.txt found. Using Random Seed."
          fi

      # 5. Download Core & Plugins (Smart Fallback Mode)
      - name: Download Paper (Smart Version Check) & Plugins
        run: |
          TARGET_VERSION="1.21.11"
          PROJECT_URL="https://api.papermc.io/v2/projects/paper"
          
          echo "ðŸ” Checking if version $TARGET_VERSION exists..."
          
          # Check if the target version is in the list of available versions
          if curl -s $PROJECT_URL | jq -e ".versions | index(\"$TARGET_VERSION\")" > /dev/null; then
            VERSION="$TARGET_VERSION"
            echo "âœ… Success! Version $VERSION found."
          else
            # If not found, grab the very last version in the list (The Absolute Latest)
            VERSION=$(curl -s $PROJECT_URL | jq -r '.versions[-1]')
            echo "âš ï¸ Version $TARGET_VERSION not found. Falling back to latest available: $VERSION"
          fi
          
          # Now fetch the latest build for whichever version we picked
          BUILD=$(curl -s $PROJECT_URL/versions/$VERSION | jq '.builds[-1]')
          
          echo "â¬‡ï¸ Downloading Paper $VERSION Build $BUILD..."
          wget -O server/paper.jar "$PROJECT_URL/versions/$VERSION/builds/$BUILD/downloads/paper-$VERSION-$BUILD.jar"
          
          # Copy Plugins from your Repo to Server
          cp -r plugins/* server/plugins/

      # 6. Configure DiscordSRV (Securely)
      - name: ðŸ”§ Configure DiscordSRV (Secure)
        env:
          # This pulls the token from your GitHub Secrets
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        run: |
          # Check if DiscordSRV jar exists to avoid errors if you haven't uploaded it yet
          if ls server/plugins/DiscordSRV*.jar 1> /dev/null 2>&1; then
            echo "DiscordSRV detected! Generating secure config..."
            mkdir -p server/plugins/DiscordSRV
            
            # ðŸ‘‡ EDIT THE NUMBERS BELOW WITH YOUR REAL CHANNEL IDs ðŸ‘‡
            # -------------------------------------------------------
            CHAT_CHANNEL_ID="1454377524250284096"
            CONSOLE_CHANNEL_ID="1433750303089623120"
            # -------------------------------------------------------
            
            # This writes the config file using your Secret Token
            cat <<EOF > server/plugins/DiscordSRV/config.yml
            BotToken: "$DISCORD_TOKEN"
            Channels: {"global": "$CHAT_CHANNEL_ID"}
            DiscordConsoleChannelId: "$CONSOLE_CHANNEL_ID"
            ConfigVersion: 1.26.0
            Experiment_JdbcAccountLinkBackend: true
            EOF
          else
            echo "DiscordSRV jar not found. Skipping config generation."
          fi

      # 7. Start the Server (With 5h 30m Safety Timer)
      - name: ðŸŸ¢ Start Server
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          # Start Tunnel
          playit --secret $PLAYIT_SECRET &
          sleep 10
          
          # Start Game
          cd server
          # Run for 19800 seconds (5 hours 30 minutes) then automatically stop to save backup
          echo "Starting server with 5h 30m safety timeout..."
          timeout 19800s java -Xms6G -Xmx6G -jar paper.jar nogui || true

      # 8. Auto-Backup (Runs on Stop/Crash)
      - name: ðŸ“¤ Backup to MEGA
        if: always() # IMPORTANT: Runs even if you cancel the workflow
        run: |
          echo "Server stopped. Starting backup..."
          cd server
          
          # Zip World AND Plugins (Excluding .jar files)
          zip -r backup.zip minecraft-worlds plugins -x "*.jar"
          
          echo "Uploading to MEGA..."
          # Save to 'minecraft-server' folder in MEGA
          rclone copy backup.zip mymega:minecraft-server/
          
          echo "âœ… Backup Complete! World & Passwords Saved."
