name: RDP with Mega Auto-Save

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      # 1. SETUP RCLONE & LOGIN AUTOMATICALLY
      # This uses your Secrets to log into Mega instantly
      - name: Setup Rclone & Login
        run: |
          choco install rclone
          # Create the config using your Email/Pass secrets
          rclone config create megaremote mega user "${{ secrets.MEGA_EMAIL }}" pass "${{ secrets.MEGA_PASS }}"
          Write-Host "Rclone is set up and logged in!"

      # 2. RESTORE DATA (Load Game)
      # Checks Mega for existing files and puts them in the 'Work' folder
      - name: Restore Data
        run: |
          Write-Host "Checking for existing backup on Mega..."
          # Create the local Work folder
          New-Item -ItemType Directory -Force -Path .\Work
          
          # Try to download. If it fails (first run), just print a message and continue.
          rclone copy megaremote:RDP_Backup/Work .\Work || Write-Host "No backup found yet (First Run). Starting fresh."
          
          Write-Host "Restore step complete."

      # 3. INSTALL PYTHON
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      # 4. START AUTO-SAVE SCRIPT
      # Runs autosave.py in the background so it doesn't block the RDP
      - name: Start Auto-Save Loop
        run: |
          Write-Host "Launching Auto-Save script..."
          # Start-Process runs it in a separate window/process
          Start-Process python -ArgumentList "autosave.py" -WindowStyle Hidden

      # 5. START RDP (*** PASTE YOUR CODE HERE ***)
      - name: Start RDP
        run: |
          # ---------------------------------------------------
          # PASTE YOUR NGROK / CLOUDFLARED / RDP CODE HERE
          # ---------------------------------------------------
          
          # Example (Uncomment and edit if you use Ngrok):
          # invoke-webrequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          # Expand-Archive ngrok.zip
          # .\ngrok\ngrok.exe tcp 3389
          
          # IMPORTANT:
          # Your RDP script usually ends with a loop (like 'loop.bat').
          # Make sure that loop is here so the workflow stays open!
          cmd /c loop.bat

      # 6. FINAL EMERGENCY BACKUP
      # This runs automatically if the 6-hour limit is hit or you cancel the workflow
      - name: Final Backup
        if: always()
        run: |
          Write-Host "Session Ending! Performing final backup..."
          rclone copy .\Work megaremote:RDP_Backup/Work
          Write-Host "Final Backup Complete. Safe to close."
