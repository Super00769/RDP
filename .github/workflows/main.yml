name: RDP (Stable + Sync Button)

on: workflow_dispatch

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      # 1. DOWNLOAD REPO (Essential)
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. SETUP RCLONE & CONFIG
      - name: Setup Rclone
        run: |
          choco install rclone -y
          # Create Shared Config at C:\rclone.conf
          rclone config create megaremote mega user "${{ secrets.MEGA_EMAIL }}" pass "${{ secrets.MEGA_PASS }}" --config "C:\rclone.conf"

      # 3. CREATE USER "RDP"
      - name: Create RDP User
        run: |
          $password = "${{ secrets.RDP_PASS }}"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

      # 4. PREPARE FILES (*** SEARCH FIX ***)
      - name: Prepare Files & Desktop
        run: |
          # A. Force Create Desktop Folders
          New-Item -ItemType Directory -Force -Path "C:\Users\RDP\Desktop"
          New-Item -ItemType Directory -Force -Path "C:\Users\RDP\Desktop\Work"

          # B. Find autosave.py automatically and move it to C:\
          # This prevents "Path not found" errors
          $script = Get-ChildItem -Path "${{ github.workspace }}" -Filter "autosave.py" -Recurse | Select-Object -First 1
          if ($script) {
              Copy-Item -Path $script.FullName -Destination "C:\autosave.py" -Force
              Write-Host "‚úÖ Found and moved autosave.py to C:\"
          } else {
              Write-Error "‚ùå Could not find autosave.py in downloaded files!"
          }

          # C. Restore Data
          rclone copy megaremote:RDP_Backup/Work "C:\Users\RDP\Desktop\Work" --config "C:\rclone.conf"

      # 5. CREATE SYNC BUTTON
      - name: Create Sync Shortcut
        run: |
          $content = "python C:\autosave.py"
          Set-Content -Path "C:\Users\RDP\Desktop\START_SYNC.bat" -Value $content

      # 6. SYSTEM SETTINGS & APPS
      - name: System & Apps
        run: |
          Set-Service -Name Audiosrv -StartupType Automatic
          Start-Service -Name Audiosrv
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fDisableAudioCapture" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

          choco install googlechrome -y --no-progress
          choco install winrar -y --no-progress
          
          $WshShell = New-Object -comObject WScript.Shell
          $ChromeLnk = $WshShell.CreateShortcut("C:\Users\RDP\Desktop\Chrome.lnk")
          $ChromeLnk.TargetPath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          $ChromeLnk.Save()

      # 7. PYTHON & TUNNEL
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Start RDP Tunnel
        run: |
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath .
          
          Write-Host "‚úÖ RDP READY"
          Write-Host "üë§ User: RDP"
          Write-Host "üîë Pass: ${{ secrets.RDP_PASS }}"
          
          .\bore.exe local 3389 --to bore.pub

      # 8. FINAL BACKUP
      - name: Final Backup
        if: always()
        run: |
          Write-Host "Performing Final Sync..."
          rclone sync "C:\Users\RDP\Desktop\Work" megaremote:RDP_Backup/Work --config "C:\rclone.conf"
