name: RDP with Mega + Bore

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      # 1. LOGIN TO MEGA (Lazy Method)
      - name: Setup Rclone & Login
        run: |
          choco install rclone
          # Logs in using your secrets
          rclone config create megaremote mega user "${{ secrets.MEGA_EMAIL }}" pass "${{ secrets.MEGA_PASS }}"
          Write-Host "Logged into Mega!"

      # 2. RESTORE DATA
      - name: Restore Data
        run: |
          New-Item -ItemType Directory -Force -Path .\Work
          # Try to download backup. If not found, ignore error.
          rclone copy megaremote:RDP_Backup/Work .\Work || Write-Host "No backup found (First Run)."

      # 3. SETUP PYTHON & AUTOSAVE
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Start Auto-Save Loop
        run: |
          # Ensure autosave.py is in your repo!
          Start-Process python -ArgumentList "autosave.py" -WindowStyle Hidden
          Write-Host "Auto-save is running in the background."

      # 4. SETUP USER & INSTALL BORE
      - name: Setup User & Bore
        run: |
          # Set the password to Super@2025
          net user runneradmin Super@2025
          
          # Enable RDP Access
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
          
          # Download Bore
          Write-Host "Downloading Bore..."
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath .
          
          Write-Host "---------------------------------------------------"
          Write-Host "âœ… RDP IS READY!"
          Write-Host "ðŸ‘¤ Username: runneradmin"
          Write-Host "ðŸ”‘ Password: Super@2025"
          Write-Host "ðŸ‘‡ CONNECT USING THE ADDRESS BELOW ðŸ‘‡"
          Write-Host "---------------------------------------------------"
          
          # Start Bore (This keeps the machine alive)
          .\bore.exe local 3389 --to bore.pub

      # 5. FINAL BACKUP (Runs if Bore crashes or time limit ends)
      - name: Final Backup
        if: always()
        run: |
          Write-Host "Session Ending! Saving data..."
          rclone copy .\Work megaremote:RDP_Backup/Work
