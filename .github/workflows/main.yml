name: RDP with Mega + Bore

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      # 1. LOGIN TO MEGA (Lazy Method)
      - name: Setup Rclone & Login
        run: |
          choco install rclone
          rclone config create megaremote mega user "${{ secrets.MEGA_EMAIL }}" pass "${{ secrets.MEGA_PASS }}"
          Write-Host "Logged into Mega successfully!"

      # 2. RESTORE DATA (*** FIXED ***)
      # "continue-on-error: true" tells GitHub: "If this fails (because it's the first run), just keep going!"
      - name: Restore Data
        continue-on-error: true
        run: |
          New-Item -ItemType Directory -Force -Path .\Work
          Write-Host "Attempting to restore backup..."
          rclone copy megaremote:RDP_Backup/Work .\Work

      # 3. SETUP PYTHON
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      # 4. START AUTO-SAVE (Background)
      - name: Start Auto-Save Loop
        run: |
          # Make sure autosave.py is in your repo files!
          Start-Process python -ArgumentList "autosave.py" -WindowStyle Hidden
          Write-Host "Auto-save script is running in the background."

      # 5. SETUP USER & START BORE
      - name: Setup User & Bore
        run: |
          # Set password
          net user runneradmin Super@2025
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
          
          # Download Bore
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath .
          
          Write-Host "---------------------------------------------------"
          Write-Host "âœ… RDP IS READY!"
          Write-Host "ðŸ‘¤ Username: runneradmin"
          Write-Host "ðŸ”‘ Password: Super@2025"
          Write-Host "ðŸ‘‡ CONNECT USING THE ADDRESS BELOW ðŸ‘‡"
          Write-Host "---------------------------------------------------"
          
          # Start Bore Tunnel
          .\bore.exe local 3389 --to bore.pub

      # 6. FINAL BACKUP (Runs even if job fails/cancels)
      - name: Final Backup
        if: always()
        run: |
          Write-Host "Session Ending! Saving data..."
          rclone copy .\Work megaremote:RDP_Backup/Work
