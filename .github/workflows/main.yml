name: RDP (Manual Sync Button + Path Fix)

on: workflow_dispatch

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      # ---------------------------------------------------
      # 1. SETUP RCLONE (Force Config Path)
      # ---------------------------------------------------
      - name: Setup Rclone & Login
        run: |
          choco install rclone
          # Force config creation at C:\rclone.conf
          rclone config create megaremote mega user "${{ secrets.MEGA_EMAIL }}" pass "${{ secrets.MEGA_PASS }}" --config "C:\rclone.conf"
          Write-Host "Config created at C:\rclone.conf"

      # ---------------------------------------------------
      # 2. CREATE USER "RDP"
      # ---------------------------------------------------
      - name: Create RDP User
        run: |
          $password = "${{ secrets.RDP_PASS }}"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

      # ---------------------------------------------------
      # 3. PREPARE FILES & FIX DESKTOP PATH
      # ---------------------------------------------------
      - name: Prepare Files & Desktop
        continue-on-error: true
        run: |
          # 1. Move python script to C:\ root
          Copy-Item "autosave.py" -Destination "C:\autosave.py"
          
          # 2. FORCE Create the RDP User's Desktop folder
          # This fixes the "Could not find part of the path" error
          $desktopPath = "C:\Users\RDP\Desktop"
          $workPath = "C:\Users\RDP\Desktop\Work"
          
          New-Item -ItemType Directory -Force -Path $desktopPath
          New-Item -ItemType Directory -Force -Path $workPath
          
          # 3. Restore Data using the shared config
          rclone copy megaremote:RDP_Backup/Work $workPath --config "C:\rclone.conf"

      # ---------------------------------------------------
      # 4. CREATE "START_SYNC" BUTTON
      # ---------------------------------------------------
      - name: Create Sync Shortcut
        run: |
          # Now that we forced the folder to exist, this will work
          $content = "python C:\autosave.py"
          Set-Content -Path "C:\Users\RDP\Desktop\START_SYNC.bat" -Value $content
          Write-Host "Shortcut created on Desktop."

      # ---------------------------------------------------
      # 5. CONFIGURE SYSTEM
      # ---------------------------------------------------
      - name: Configure System
        run: |
          Set-Service -Name Audiosrv -StartupType Automatic
          Start-Service -Name Audiosrv
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fDisableAudioCapture" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      # ---------------------------------------------------
      # 6. INSTALL APPS
      # ---------------------------------------------------
      - name: Install Apps
        run: |
          choco install googlechrome -y --no-progress
          choco install winrar -y --no-progress
          
          # Create Chrome Shortcut
          $WshShell = New-Object -comObject WScript.Shell
          $ChromeLnk = $WshShell.CreateShortcut("C:\Users\RDP\Desktop\Chrome.lnk")
          $ChromeLnk.TargetPath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          $ChromeLnk.Save()

      # ---------------------------------------------------
      # 7. SETUP PYTHON
      # ---------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      # ---------------------------------------------------
      # 8. START RDP TUNNEL
      # ---------------------------------------------------
      - name: Start RDP Tunnel
        run: |
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath .
          
          Write-Host "âœ… RDP IS READY"
          Write-Host "ðŸ‘¤ User: RDP"
          Write-Host "ðŸ”‘ Pass: ${{ secrets.RDP_PASS }}"
          
          .\bore.exe local 3389 --to bore.pub

      # ---------------------------------------------------
      # 9. FINAL BACKUP
      # ---------------------------------------------------
      - name: Final Backup
        if: always()
        run: |
          Write-Host "Performing Final Sync..."
          # Uses the forced config path
          rclone sync "C:\Users\RDP\Desktop\Work" megaremote:RDP_Backup/Work --config "C:\rclone.conf"
