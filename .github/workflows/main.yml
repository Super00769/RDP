name: RDP (Smart Sync + Public Desktop)

on: workflow_dispatch

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      # ---------------------------------------------------
      # 1. SETUP RCLONE & LOGIN
      # ---------------------------------------------------
      - name: Setup Rclone & Login
        run: |
          choco install rclone
          rclone config create megaremote mega user "${{ secrets.MEGA_EMAIL }}" pass "${{ secrets.MEGA_PASS }}"
          Write-Host "Logged into Mega!"

      # ---------------------------------------------------
      # 2. CREATE USER "RDP" (Securely)
      # ---------------------------------------------------
      - name: Create RDP User
        run: |
          # Uses your Secret Password (Hidden in logs)
          $password = "${{ secrets.RDP_PASS }}"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

      # ---------------------------------------------------
      # 3. RESTORE DATA -> TO PUBLIC DESKTOP
      # ---------------------------------------------------
      - name: Restore Data
        continue-on-error: true
        run: |
          # Public Desktop = Visible to ALL users immediately
          $workPath = "C:\Users\Public\Desktop\Work"
          
          New-Item -ItemType Directory -Force -Path $workPath
          Write-Host "Restoring backup to: $workPath"
          
          # We use 'copy' here to safely bring files down
          rclone copy megaremote:RDP_Backup/Work $workPath

      # ---------------------------------------------------
      # 4. CONFIGURE SYSTEM & AUDIO
      # ---------------------------------------------------
      - name: Configure System
        run: |
          Set-Service -Name Audiosrv -StartupType Automatic
          Start-Service -Name Audiosrv
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "fDisableAudioCapture" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxDisconnectionTime" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389

      # ---------------------------------------------------
      # 5. INSTALL APPS (Shortcuts on Public Desktop)
      # ---------------------------------------------------
      - name: Install Apps
        run: |
          choco install googlechrome -y --no-progress
          choco install winrar -y --no-progress
          
          # Shortcut for Chrome
          $WshShell = New-Object -comObject WScript.Shell
          $ChromeLnk = $WshShell.CreateShortcut("C:\Users\Public\Desktop\Chrome.lnk")
          $ChromeLnk.TargetPath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          $ChromeLnk.Save()

      # ---------------------------------------------------
      # 6. START SMART SYNC (Background)
      # ---------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Launch Auto-Save
        run: |
          # Starts the Smart Sync Monitor
          Start-Process python -ArgumentList "autosave.py" -WindowStyle Hidden
          Write-Host "Smart Sync started. Watching C:\Users\Public\Desktop\Work"

      # ---------------------------------------------------
      # 7. START BORE TUNNEL
      # ---------------------------------------------------
      - name: Start RDP Tunnel
        run: |
          Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.zip -OutFile bore.zip
          Expand-Archive bore.zip -DestinationPath .
          
          Write-Host "---------------------------------------------------"
          Write-Host "âœ… RDP IS READY"
          Write-Host "ðŸ‘¤ User: RDP"
          Write-Host "ðŸ”‘ Pass: ${{ secrets.RDP_PASS }}"
          Write-Host "---------------------------------------------------"
          
          .\bore.exe local 3389 --to bore.pub

      # ---------------------------------------------------
      # 8. FINAL BACKUP
      # ---------------------------------------------------
      - name: Final Backup
        if: always()
        run: |
          Write-Host "Session Ending... Performing Final Sync..."
          rclone sync "C:\Users\Public\Desktop\Work" megaremote:RDP_Backup/Work
