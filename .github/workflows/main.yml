name: Organized Server 1.21.4

on:
  workflow_dispatch:

jobs:
  run-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Playit & JQ
        run: |
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit jq

      - name: Setup Server Folders
        run: |
          # Create the folder where worlds will live
          mkdir -p server/minecraft-worlds
          mkdir -p server/plugins

          # Tell the server: "Put standard worlds inside the minecraft-worlds folder"
          echo "settings:" > server/bukkit.yml
          echo "  world-container: minecraft-worlds" >> server/bukkit.yml
          
          # Basic Configs
          echo "server-port=25565" > server/server.properties
          echo "online-mode=false" >> server/server.properties
          echo "eula=true" > server/eula.txt

      - name: Download Paper 1.21.4 (Auto-Latest)
        run: |
          VERSION="1.21.4"
          BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$VERSION | jq '.builds[-1]')
          echo "Downloading Paper $VERSION Build $BUILD..."
          wget -O server/paper.jar "https://api.papermc.io/v2/projects/paper/versions/$VERSION/builds/$BUILD/downloads/paper-$VERSION-$BUILD.jar"

      - name: Copy Plugins
        run: cp plugins/*.jar server/plugins/

      - name: Start Server
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          playit --secret $PLAYIT_SECRET &
          sleep 10
          cd server
          java -Xms6G -Xmx6G -jar paper.jar nogui
