name: Ultimate Minecraft Server

on:
  workflow_dispatch: # Manual "Run" button

jobs:
  server:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Setup Environment
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Dependencies (Playit, Rclone, JQ)
        run: |
          # Install Playit
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt-get update
          sudo apt-get install playit jq zip unzip
          
          # Install Rclone (for MEGA backup)
          sudo -v ; curl https://rclone.org/install.sh | sudo bash

      # 2. Connect to MEGA Cloud
      - name: Configure MEGA
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASS: ${{ secrets.MEGA_PASS }}
        run: |
          # Create a secure connection profile named 'mymega'
          rclone config create mymega mega user "$MEGA_EMAIL" pass "$MEGA_PASS"

      # 3. Restore World (If backup exists)
      - name: ðŸ“¥ Restore World Backup
        run: |
          mkdir -p server/minecraft-worlds
          mkdir -p server/plugins
          
          echo "Checking MEGA for previous backup..."
          
          # Try to download. If fail, just print message and continue.
          rclone copy mymega:minecraft-server/backup.zip server/ || echo "No backup found. Creating New World!"
          
          if [ -f server/backup.zip ]; then
            echo "Backup found! Unzipping..."
            unzip -o server/backup.zip -d server/
            rm server/backup.zip
          fi

      # 4. Setup Server Logic
      - name: Configure Server & Folders
        run: |
          # Force worlds into the 'minecraft-worlds' folder
          echo "settings:" > server/bukkit.yml
          echo "  world-container: minecraft-worlds" >> server/bukkit.yml
          
          # Server Properties (Cracked + Optimized)
          echo "server-port=25565" > server/server.properties
          echo "online-mode=false" >> server/server.properties
          echo "motd=GitHub Actions Server" >> server/server.properties
          echo "eula=true" > server/eula.txt

      # 5. Download Core & Plugins
      - name: Download Paper 1.21.11 & Plugins
        run: |
          # Auto-Fetch Latest Paper Build for 1.21.11
          VERSION="1.21.11" 
          BUILD=$(curl -s https://api.papermc.io/v2/projects/paper/versions/$VERSION | jq '.builds[-1].build')
          echo "Downloading Paper $VERSION Build $BUILD..."
          wget -O server/paper.jar "https://api.papermc.io/v2/projects/paper/versions/$VERSION/builds/$BUILD/downloads/paper-$VERSION-$BUILD.jar"
          
          # Copy Plugins from your Repo to Server
          # This command automatically copies your manual config.yml too!
          cp -r plugins/* server/plugins/

      # 6. Start the Server
      - name: ðŸŸ¢ Start Server
        env:
          PLAYIT_SECRET: ${{ secrets.PLAYIT_SECRET }}
        run: |
          # Start Tunnel
          playit --secret $PLAYIT_SECRET &
          sleep 10
          
          # Start Game
          cd server
          java -Xms6G -Xmx6G -jar paper.jar nogui

      # 7. Auto-Backup (Runs on Stop/Crash)
      - name: ðŸ“¤ Backup to MEGA
        if: always() # IMPORTANT: Runs even if you cancel the workflow
        run: |
          echo "Server stopped. Starting backup..."
          cd server
          
          # Zip ONLY the world data
          zip -r backup.zip minecraft-worlds
          
          echo "Uploading to MEGA..."
          # Save to 'minecraft-server' folder in MEGA
          rclone copy backup.zip mymega:minecraft-server/
          
          echo "âœ… Backup Complete! Data Saved."
